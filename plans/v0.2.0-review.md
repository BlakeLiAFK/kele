# Kele v0.2.0 开发计划回顾与审查

> 审查日期: 2026-02-18

## 一、总体评估

v0.2.0 计划共 5 个 Epic、16 个任务。实际完成情况：

| Epic | 计划任务数 | 完成 | 部分完成 | 未完成 | 完成率 |
|------|-----------|------|---------|--------|-------|
| 1. 配置系统重构 | 2 | 2 | 0 | 0 | 100% |
| 2. 多模型适配层 | 4 | 4 | 0 | 0 | 100% |
| 3. 工具系统扩展 | 4 | 4 | 0 | 0 | 100% |
| 4. 记忆系统增强 | 3 | 1 | 2 | 0 | ~60% |
| 5. 稳定性与质量 | 3 | 1 | 2 | 0 | ~70% |
| **合计** | **16** | **12** | **4** | **0** | **~85%** |

**总结**：核心功能（Epic 1-3）全部交付，质量较高。记忆系统（Epic 4）和稳定性（Epic 5）存在明显缺口。

---

## 二、各 Epic 详细审查

### Epic 1：配置系统重构 — ✅ 完全完成

#### 任务 1.1：统一配置结构体 ✅

`internal/config/config.go` 完整实现了计划中的所有子配置：

| 计划要求 | 实现状态 | 备注 |
|---------|---------|------|
| LLMConfig (APIBase, APIKey, Model...) | ✅ | 还额外支持了 Anthropic/Ollama 的独立配置 |
| ToolsConfig (DangerousCommands, Timeout...) | ✅ | 包含 MaxWriteSize（计划中未提及，属于额外安全加固） |
| MemoryConfig (DBPath, MemoryFile, SessionDir) | ✅ | |
| TUIConfig (MaxSessions, MaxInputChars, Theme) | ✅ | Theme 字段存在但未使用 |
| CronConfig (JobTimeout, LogRetention...) | ✅ | |
| 环境变量优先级高于配置文件 | ✅ | `LoadFromEnv()` 正确覆盖 |
| 缺省值与 v0.1.3 行为一致 | ✅ | |
| 单元测试 | ✅ | 7 个测试覆盖加载、合并、缺省逻辑 |

**验收标准达成率**: 5/5 (100%)

#### 任务 1.2：CLI 启动参数 ✅

| 计划要求 | 实现状态 | 备注 |
|---------|---------|------|
| `--version` 输出版本号 | ✅ | 输出 "Kele v0.2.0" |
| `--model` 覆盖默认模型 | ✅ | 通过 `ApplyFlags` 实现 |
| `--debug` 启用调试日志 | ⚠️ | flag 存在，但未集成到日志系统（无 debug.log 文件输出） |
| `--config <path>` 指定配置路径 | ⚠️ | 未在代码中找到此 flag 的实现 |
| 优先级：CLI > 环境变量 > 配置文件 > 默认值 | ✅ | |

**验收标准达成率**: 3/5 (60%) — `--debug` 和 `--config` 未完整实现

---

### Epic 2：多模型适配层 — ✅ 完全完成

#### 任务 2.1：LLM Provider 接口抽象 ✅

`internal/llm/provider.go` 实现了完整的 Provider 体系：

- ✅ `Provider` 接口：Chat / ChatStream / SupportsTools / Name
- ✅ `ProviderManager`：管理多 Provider，按模型名自动路由
- ✅ Brain 通过 `*ProviderManager` 间接调用，完成解耦
- ✅ 线程安全（sync.RWMutex）
- ✅ 8 个单元测试覆盖

**注意**：接口定义与计划略有差异（`SupportsTools()` 替代了 `Models()`），但功能更合理。

#### 任务 2.2：Anthropic Claude 适配器 ✅

`internal/llm/anthropic.go`（441 行）是本次实现质量最高的模块之一：

- ✅ `x-api-key` 认证（非 Bearer Token）
- ✅ `system` 字段独立处理
- ✅ SSE 流式解析（`content_block_delta`）
- ✅ 工具调用 `tool_use` content block 正确转换
- ✅ thinking process（`thinking_delta`）支持
- ✅ 非流式 Chat 和流式 ChatStream 均实现
- ✅ 格式转换函数完备（convertToAnthropic / convertFromAnthropic / convertToolsToAnthropic）

**验收标准达成率**: 5/5 (100%)

#### 任务 2.3：Ollama 本地模型适配器 ✅

`internal/llm/ollama.go`（58 行）采用委托模式实现：

- ✅ 默认端口 `localhost:11434`
- ✅ 无需 API Key
- ✅ 10 分钟超时（适应本地推理）
- ✅ 基于 OpenAI 兼容接口实现
- ❌ 未实现"自动发现已安装模型列表"（计划验收标准之一）
- ❌ 未实现"工具调用不支持时 graceful degradation"

**验收标准达成率**: 2/4 (50%)

#### 任务 2.4：模型管理 UI 增强 ✅

- ✅ `/models` 按 Provider 分组显示
- ✅ `/model <name>` 模糊匹配
- ✅ `/model-reset` 重置到默认
- ✅ `/model-small` 设置小模型
- ❌ `/model-info` 未实现（计划中要求显示 Provider、上下文长度、工具支持）
- ⚠️ 状态栏显示 Provider 名称（但非图标）

**验收标准达成率**: 2/3 (67%)

---

### Epic 3：工具系统扩展 — ✅ 完全完成

#### 任务 3.1：工具注册机制重构 ✅

`internal/tools/registry.go` 实现了干净的插件架构：

- ✅ `ToolHandler` 接口（Name/Description/Parameters/Execute）
- ✅ `Registry` 支持动态注册
- ✅ bash/read/write/cron 已重构为独立 ToolHandler
- ✅ `/tools` 命令可查看工具列表
- ✅ 线程安全、保持注册顺序

**验收标准达成率**: 4/4 (100%)

#### 任务 3.2：HTTP 工具（curl）✅

`internal/tools/http.go` 实现完善：

- ✅ GET / POST / PUT / DELETE
- ✅ 自定义 headers 和 body
- ✅ 超时 30 秒，重定向限制 5 次
- ✅ 输出截断（可配置，默认 50KB）
- ✅ 内网地址安全检查（127.0.0.1, 10.x, 192.168.x, 172.16-31.x）

**验收标准达成率**: 5/5 (100%)

#### 任务 3.3：Git 工具 ✅

`internal/tools/git.go` 实现：

- ✅ 子命令白名单（status, diff, log, add, commit, branch, checkout, show, stash, blame, tag, remote）— 超出计划要求
- ✅ 危险操作拦截（push --force, reset --hard, clean -f, branch -D）
- ✅ 非 Git 仓库检测
- ❌ diff 输出无语法高亮（计划中提及但未实现）

**验收标准达成率**: 4/5 (80%)

#### 任务 3.4：Python 执行工具 ✅

`internal/tools/python.go` 实现：

- ✅ 临时文件 + python3 执行
- ✅ 30 秒超时
- ✅ 输出截断 50KB
- ✅ Python 未安装时友好提示

**验收标准达成率**: 4/4 (100%)

---

### Epic 4：记忆系统增强 — ⚠️ 部分完成（约 60%）

#### 任务 4.1：全文搜索升级 — ❌ 未实现（核心缺口）

| 计划要求 | 实现状态 | 当前实现 |
|---------|---------|---------|
| FTS5 虚拟表 | ❌ | 使用普通 `LIKE '%keyword%'` 查询 |
| BM25 相关性排序 | ❌ | 按 `updated_at DESC` 排序 |
| 中文分词 | ❌ | 无分词，依赖 LIKE 子串匹配 |
| `/search` 高亮匹配关键词 | ❌ | 返回原文，无高亮 |
| 搜索延迟 < 50ms | ⚠️ | 小数据量下可达标，大数据量 LIKE 查询性能不可预测 |

**背景**：v0.1.0 曾引入 FTS5 但在 v0.1.1 因编译问题回退。v0.2.0 计划重新引入但最终未实现。这是一个**反复出现的技术障碍**。

**验收标准达成率**: 0/4 (0%)

#### 任务 4.2：上下文窗口优化 — ⚠️ 部分完成

| 计划要求 | 实现状态 | 备注 |
|---------|---------|------|
| 可配置 `maxTurns` | ✅ | `cfg.LLM.MaxTurns`，默认 20 |
| 工具结果压缩（>2KB 自动摘要）| ❌ | 仅截断（50KB），无智能摘要 |
| System prompt 动态注入 memory | ❌ | 静态 system prompt，无 memory 注入 |
| Token 计数估算 | ✅ | `EstimateTokens()` 实现（4字符≈1token） |
| `/tokens` 命令 | ✅ | 显示估算值 |

**验收标准达成率**: 2/4 (50%)

**影响分析**：
- 工具输出无压缩意味着长输出会快速消耗上下文窗口
- 无 memory 注入意味着 AI 无法自动参考历史记忆，降低了记忆系统的实际价值

#### 任务 4.3：会话持久化 — ⚠️ 部分完成

| 计划要求 | 实现状态 | 备注 |
|---------|---------|------|
| 退出时自动保存 | ⚠️ | 手动 `/save`，非自动 |
| 启动时提示恢复上次会话 | ❌ | 无自动恢复提示 |
| `/sessions` 显示历史列表 | ✅ | 显示 ID、消息数 |
| `/load <id>` 加载历史会话 | ⚠️ | `LoadSession` 方法存在但 TUI 中 `/load` 命令未完整集成 |

**验收标准达成率**: 1/4 (25%)

---

### Epic 5：稳定性与质量 — ⚠️ 部分完成（约 70%）

#### 任务 5.1：核心模块测试补齐 — ⚠️ 大部分完成

| 模块 | 计划要求 | 实现状态 |
|------|---------|---------|
| `internal/config/` | 至少 1 个 _test.go | ✅ config_test.go（7 tests） |
| `internal/cron/` | 至少 1 个 _test.go | ✅ cron_test.go（18 tests） |
| `internal/llm/` | 至少 1 个 _test.go | ✅ provider_test.go（8 tests） |
| `internal/memory/` | 至少 1 个 _test.go | ✅ store_test.go（7 tests） |
| `internal/tools/` | 至少 1 个 _test.go | ✅ tools_test.go |
| `internal/tui/` | 至少 1 个 _test.go | ✅ app_test.go + completion_test.go + reference_test.go |
| `internal/agent/` | 至少 1 个 _test.go | ❌ **无测试文件** |

- ✅ `go test ./...` 全部 103 个测试通过
- ✅ `go vet ./...` 无警告
- ❌ `internal/agent/` 包无测试 — Brain 是核心模块，缺乏测试是较大风险

**验收标准达成率**: 3/4 (75%)

#### 任务 5.2：安全加固 — ⚠️ 大部分完成

| 计划要求 | 实现状态 | 备注 |
|---------|---------|------|
| 危险命令列表统一管理 | ✅ | `DefaultDangerousCommands` 单一来源 |
| Bash 输出截断 50KB | ✅ | `MaxOutputSize` 可配置 |
| 命令执行超时 60 秒 | ✅ | `BashTimeout` 可配置 |
| 文件写入限制 1MB | ✅ | `MaxWriteSize` 可配置 |
| 审计日志 | ❌ | **完全未实现** — 无工具调用审计记录 |

**验收标准达成率**: 4/5 (80%)

#### 任务 5.3：错误处理完善 — ⚠️ 部分完成

| 计划要求 | 实现状态 | 备注 |
|---------|---------|------|
| API 错误分类 | ✅ | `classifyAPIError()` 覆盖 401/403/404/429/500+ |
| 自动重试（3次指数退避）| ❌ | **未实现** — 失败立即返回错误 |
| 工具执行错误清晰消息 | ✅ | 中文友好提示 |
| 状态栏显示最近错误 | ⚠️ | 错误会显示但无持久化状态栏展示 |

**验收标准达成率**: 2/4 (50%)

---

## 三、发布验收清单对照

### 功能验收

| 检查项 | 状态 |
|--------|------|
| `kele --version` 输出 v0.2.0 | ✅ |
| `kele --config custom.yaml` 正常加载 | ❌ 未实现 |
| 默认配置下向后兼容 v0.1.3 | ✅ |
| OpenAI 模型正常对话 + 工具调用 | ✅ |
| Claude 模型正常对话 + 工具调用 | ✅ |
| Ollama 本地模型正常对话 | ✅ |
| `/models` 按 Provider 分组 | ✅ |
| `/model <name>` 模糊匹配 | ✅ |
| curl 工具获取网页/API | ✅ |
| git status/diff/log/add/commit | ✅ |
| Python 代码执行 | ✅ |
| `/search` 全文搜索按相关性排序 | ❌ 无 BM25 排序 |
| `/tokens` 显示 Token 估算 | ✅ |
| 退出后重启恢复会话 | ❌ 未实现自动恢复 |
| 危险命令统一拦截 | ✅ |

**功能验收达成率**: 11/15 (73%)

### 质量验收

| 检查项 | 状态 |
|--------|------|
| `go test ./...` 全部通过 | ✅ |
| 每个 internal/ 包有测试 | ❌ agent/ 缺失 |
| `go vet ./...` 无警告 | ✅ |
| `golangci-lint run` 无 error | ⚠️ 未验证 |
| 无 hardcoded 敏感信息 | ✅ |
| CHANGELOG.md 更新 | ❌ **未更新 v0.2.0 条目** |
| README.md 更新 | ⚠️ 未验证 |

**质量验收达成率**: 3/7 (43%)

### 性能验收

| 检查项 | 状态 |
|--------|------|
| 启动时间 < 1 秒 | ✅ |
| 内存占用 < 30MB | ✅ |
| 搜索延迟 < 50ms（1000条）| ⚠️ LIKE 查询在大数据量下不保证 |
| 流式首 token 无显著退化 | ✅ |

---

## 四、文档一致性问题

### 1. STATUS.md 已过时
- **最后更新**: 2026-02-07
- **问题**: "待办"列表仍为：GoClaw 核心网关、聊天适配器、记忆系统
- 这些待办项与 v0.2.0 的实际工作方向不一致，v0.2.0 的方向已转向多模型适配和工具扩展
- **建议**: 更新为当前实际待办事项

### 2. FEATURES.md 未同步更新
- "短期计划 (v0.2.0)" 部分仍将已实现的功能标记为 `[ ]`
- 列出的 v0.2.0 目标包含"向量检索"和"心跳机制"，但 v0.2.0-plan.md 已将它们明确排除
- 多模型支持、curl/git/python 工具等已实现功能应标记为 ✅
- **建议**: 全面更新功能清单，反映 v0.2.0 实际交付

### 3. CHANGELOG.md 缺少 v0.2.0 条目
- 最新条目仍为 v0.1.3（2026-02-06）
- v0.2.0 是一次重大发布（多 Provider、工具系统、配置重构），缺少变更记录不可接受
- **建议**: 补充完整的 v0.2.0 CHANGELOG

### 4. v0.1.0 CHANGELOG 中的误导性信息
- 声称 "SQLite 全文检索（FTS5）" 已实现
- 但 v0.1.1 就因编译问题回退了 FTS5
- **建议**: 在 v0.1.0 条目中标注此功能已在后续版本回退

---

## 五、未完成项汇总（按优先级排列）

### P0 — 必须在声明 v0.2.0 发布前解决

| # | 缺口 | Epic | 影响 |
|---|------|------|------|
| 1 | CHANGELOG.md 缺少 v0.2.0 条目 | 发布 | 用户无法了解版本更新内容 |
| 2 | `internal/agent/` 无单元测试 | 5.1 | 核心模块无测试覆盖是重大风险 |

### P1 — 重要缺口，建议尽快补齐

| # | 缺口 | Epic | 影响 |
|---|------|------|------|
| 3 | FTS5 全文搜索未实现 | 4.1 | 搜索质量差，大数据量性能不可预测 |
| 4 | API 自动重试（指数退避）未实现 | 5.3 | 网络不稳定时用户体验差 |
| 5 | 审计日志未实现 | 5.2 | 无法追踪工具调用历史 |
| 6 | 启动时自动恢复会话未实现 | 4.3 | 退出后丢失工作上下文 |

### P2 — 增强性缺口，可纳入 v0.2.1

| # | 缺口 | Epic | 影响 |
|---|------|------|------|
| 7 | 工具输出智能压缩（>2KB 摘要）| 4.2 | 长输出消耗上下文窗口 |
| 8 | System prompt 动态注入 memory | 4.2 | AI 无法自动引用历史记忆 |
| 9 | `--config <path>` CLI flag | 1.2 | 无法指定自定义配置文件路径 |
| 10 | `--debug` 输出到 debug.log | 1.2 | 调试不便 |
| 11 | `/model-info` 命令 | 2.4 | 无法查看模型详情 |
| 12 | Ollama 模型自动发现 | 2.3 | 用户需要手动指定模型名 |
| 13 | Ollama 工具调用 graceful degradation | 2.3 | 不支持工具时无降级提示 |
| 14 | Git diff 语法高亮 | 3.3 | 可读性一般 |
| 15 | FEATURES.md / STATUS.md 同步更新 | 文档 | 文档与实际状态不一致 |

---

## 六、代码质量观察

### 优点
1. **模块划分清晰** — internal/ 下各包职责单一，依赖方向合理
2. **Anthropic 适配器质量高** — 441 行代码处理了 API 差异、流式解析、工具调用转换，逻辑完备
3. **工具注册机制优雅** — Registry 模式使新增工具只需一行 Register 调用
4. **测试覆盖面广** — 103 个测试覆盖 6 个包，核心路径有保障
5. **安全意识到位** — HTTP 内网拦截、Git 危险操作白名单、文件写入限制

### 值得关注的问题
1. **`memory/store.go` 中 panic 的使用** — `NewStore` 和 `initSchema` 中 DB 错误直接 panic，生产环境应返回 error
2. **Brain 未测试** — `agent/brain.go` 是系统核心（工具循环、上下文管理），无测试覆盖
3. **FTS5 是反复失败的技术点** — v0.1.0 引入 → v0.1.1 回退 → v0.2.0 计划重新引入但未实现，建议深入调研 CGO/SQLite FTS5 编译问题的根因
4. **错误处理中的 `continue`** — `store.go` 多处 `rows.Scan` 错误用 `continue` 跳过，可能导致数据静默丢失

---

## 七、建议的后续行动

### 立即执行（发布 v0.2.0 前）
1. 补充 CHANGELOG.md v0.2.0 条目
2. 为 `internal/agent/` 编写基础单元测试（至少覆盖 Chat 工具循环和 trimHistory）
3. 更新 FEATURES.md 和 STATUS.md

### v0.2.1 计划
1. 解决 FTS5 编译问题，实现全文搜索
2. 实现 API 自动重试（3 次指数退避）
3. 实现审计日志（工具调用记录到 `~/.kele/audit.log`）
4. 实现启动时自动恢复上次会话
5. 实现 `--config` 和 `--debug` flag

### v0.3.0 考虑
1. 工具输出智能压缩（利用小模型生成摘要）
2. System prompt 动态 memory 注入
3. Ollama 模型自动发现（调用 `/api/tags`）
4. 将 `memory/store.go` 中的 panic 改为 error 返回
