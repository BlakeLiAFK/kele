# Kele v0.2.0 开发计划

> 基于 v0.1.3 代码深度分析制定 | 2026-02-16

## 一、版本目标

将 Kele 从"可用的 MVP"升级为"可靠的日常工具"。核心方向：

1. **多模型适配** — 不再绑定 OpenAI，支持 Claude / Gemini / Ollama
2. **配置系统** — 消除大量硬编码，支持 YAML 配置
3. **工具扩展** — 新增 curl、git 等高频工具
4. **记忆增强** — 改进搜索能力，提升上下文管理
5. **稳定性** — 补齐测试覆盖、错误处理、安全加固

---

## 二、任务分解

### Epic 1：配置系统重构

**背景**：当前代码中存在 20+ 处硬编码值（温度、Token 上限、超时、路径等），无法通过配置调整。

#### 任务 1.1：统一配置结构体

- **目标**：创建 `internal/config/config.go`，定义全局配置结构体
- **工作内容**：
  - 定义 `Config` 结构体，包含以下子配置：
    ```go
    type Config struct {
        LLM      LLMConfig
        Tools    ToolsConfig
        Memory   MemoryConfig
        TUI      TUIConfig
        Cron     CronConfig
    }
    ```
  - `LLMConfig`：APIBase, APIKey, Model, SmallModel, Temperature, MaxTokens, MaxCompletionTokens, Timeout
  - `ToolsConfig`：DangerousCommands []string, BashTimeout, MaxOutputSize
  - `MemoryConfig`：DBPath, MemoryFilePath, SessionDir, MaxTurns, CleanupPolicy
  - `TUIConfig`：MaxSessions, MaxInputChars, Theme
  - `CronConfig`：JobTimeout, LogRetention, MaxConcurrent
- **验收标准**：
  - [ ] 所有硬编码值迁移到配置结构体
  - [ ] 支持从 `.kele/config.yaml` 加载
  - [ ] 环境变量优先级高于配置文件
  - [ ] 缺省值与当前行为一致（不引入 breaking change）
  - [ ] 单元测试覆盖配置加载、合并、缺省逻辑

#### 任务 1.2：CLI 启动参数

- **目标**：`main.go` 支持常用命令行参数
- **工作内容**：
  - `--config <path>`：指定配置文件路径
  - `--version`：显示版本号
  - `--debug`：启用调试日志输出
  - `--model <name>`：覆盖默认模型
- **验收标准**：
  - [ ] `kele --version` 输出版本号
  - [ ] `kele --debug` 将日志输出到 `~/.kele/debug.log`
  - [ ] CLI 参数 > 环境变量 > 配置文件 > 默认值

---

### Epic 2：多模型适配层

**背景**：当前 `llm/client.go` 仅支持 OpenAI 格式 API。Claude（Anthropic）和 Gemini（Google）的 API 格式不同，需要适配层。

#### 任务 2.1：LLM Provider 接口抽象

- **目标**：定义统一的 Provider 接口，解耦 Brain 与具体 API
- **工作内容**：
  - 定义 `Provider` 接口：
    ```go
    type Provider interface {
        Chat(ctx context.Context, req ChatRequest) (*ChatResponse, error)
        ChatStream(ctx context.Context, req ChatRequest) (<-chan StreamEvent, error)
        Models() []string
        Name() string
    }
    ```
  - 将当前 `Client` 重构为 `OpenAIProvider`，实现上述接口
  - 创建 `ProviderRegistry` 管理多个 Provider
  - Brain 通过接口调用，不再直接依赖 `*llm.Client`
- **验收标准**：
  - [ ] `Provider` 接口定义完成，包含 Chat / ChatStream / Models / Name
  - [ ] 现有 OpenAI 功能不受影响（通过 `OpenAIProvider` 实现）
  - [ ] Brain 与 Provider 解耦，可注入任意实现
  - [ ] 单元测试覆盖 Provider 注册与路由逻辑

#### 任务 2.2：Anthropic Claude 适配器

- **目标**：支持 Anthropic Messages API（Claude 3.5 / 4 系列）
- **工作内容**：
  - 实现 `AnthropicProvider`
  - 处理 API 差异：
    - 认证方式：`x-api-key` header（非 Bearer Token）
    - 请求格式：`system` 独立字段（非 messages 数组）
    - 流式格式：SSE `content_block_delta`（非 OpenAI 的 `choices[0].delta`）
    - 工具调用：`tool_use` content block（非 `tool_calls` 数组）
  - 环境变量：`ANTHROPIC_API_KEY`
- **验收标准**：
  - [ ] 通过 `/model claude-sonnet-4-5-20250929` 切换到 Claude
  - [ ] 流式输出正常，thinking 过程可显示
  - [ ] 工具调用循环正常工作
  - [ ] 错误信息友好（API key 缺失、模型不存在等）
  - [ ] 集成测试通过（可 mock API）

#### 任务 2.3：Ollama 本地模型适配器

- **目标**：支持 Ollama 本地推理（零成本、离线可用）
- **工作内容**：
  - 实现 `OllamaProvider`
  - Ollama 使用 OpenAI 兼容格式，但有差异：
    - 默认端口 `http://localhost:11434/v1`
    - 无需 API Key
    - 模型名使用 Ollama 格式（如 `llama3:8b`）
    - 工具调用支持有限，需要 fallback 机制
  - 环境变量：`OLLAMA_HOST`（默认 localhost:11434）
- **验收标准**：
  - [ ] `/model llama3:8b` 切换到本地 Ollama 模型
  - [ ] 离线状态下可正常对话
  - [ ] 工具调用在不支持时 graceful degradation（提示用户手动执行）
  - [ ] 自动发现已安装的 Ollama 模型列表

#### 任务 2.4：模型管理 UI 增强

- **目标**：改进 `/models` 和 `/model` 命令的交互体验
- **工作内容**：
  - `/models` 按 Provider 分组显示，标注当前选中
  - `/model <name>` 支持模糊匹配（如 `claude` → `claude-sonnet-4-5-20250929`）
  - `/model-info` 显示当前模型详情（Provider、上下文长度、是否支持工具调用）
  - 状态栏显示当前 Provider 图标
- **验收标准**：
  - [ ] `/models` 输出分组清晰，标注活跃模型
  - [ ] 模糊匹配准确，歧义时提示用户选择
  - [ ] 状态栏实时反映当前 Provider

---

### Epic 3：工具系统扩展

**背景**：当前仅有 bash / read / write 三个基础工具。用户高频操作（HTTP 请求、Git 操作）需要额外工具支持。

#### 任务 3.1：工具注册机制重构

- **目标**：将硬编码的工具定义改为插件式注册
- **工作内容**：
  - 定义 `Tool` 接口：
    ```go
    type Tool interface {
        Name() string
        Description() string
        Parameters() map[string]interface{}
        Execute(args map[string]interface{}) (string, error)
    }
    ```
  - 创建 `ToolRegistry`，支持动态注册
  - 重构 `executor.go`，将 bash / read / write 改为独立 Tool 实现
  - `GetTools()` 从 Registry 动态生成
- **验收标准**：
  - [ ] 现有 bash / read / write / cron 工具正常工作
  - [ ] 新工具可通过 `registry.Register(tool)` 一行代码注册
  - [ ] 工具列表可通过 `/tools` 命令查看
  - [ ] 单元测试覆盖注册和执行路由

#### 任务 3.2：HTTP 工具（curl）

- **目标**：AI 可直接发起 HTTP 请求获取外部信息
- **工作内容**：
  - 支持 GET / POST / PUT / DELETE
  - 参数：url, method, headers, body, timeout
  - 输出截断：响应体超过 10KB 时截断并提示
  - 安全限制：禁止访问内网地址（127.0.0.1、10.x、192.168.x 等）
- **验收标准**：
  - [ ] AI 可调用 curl 工具获取公网 API 数据
  - [ ] POST 请求可发送 JSON body
  - [ ] 超时和大响应体有合理限制
  - [ ] 内网地址访问被拒绝并返回安全提示
  - [ ] 单元测试覆盖各 HTTP 方法和安全检查

#### 任务 3.3：Git 工具

- **目标**：AI 可执行 Git 操作辅助开发
- **工作内容**：
  - 子命令：status, diff, log, add, commit, branch, checkout
  - 安全限制：
    - 禁止 `push --force`、`reset --hard`、`clean -f`
    - `commit` 和 `checkout` 需在工具输出中明确告知用户
  - 输出格式化：diff 输出语法高亮
- **验收标准**：
  - [ ] AI 可查看 git status、diff、log
  - [ ] AI 可执行 add、commit（带消息）
  - [ ] 危险操作被拦截
  - [ ] 非 Git 仓库中调用时给出友好提示
  - [ ] 单元测试覆盖各子命令和安全检查

#### 任务 3.4：Python 执行工具

- **目标**：AI 可执行 Python 代码片段（数据分析、计算等场景）
- **工作内容**：
  - 参数：code（Python 代码字符串）
  - 使用临时文件 + `python3` 执行
  - 超时限制：30 秒
  - 输出截断：stdout + stderr 合并，超 10KB 截断
- **验收标准**：
  - [ ] AI 可执行简单 Python 脚本并获取输出
  - [ ] 超时和大输出有合理限制
  - [ ] Python 未安装时给出友好提示
  - [ ] 单元测试覆盖正常执行、超时、错误场景

---

### Epic 4：记忆系统增强

**背景**：当前搜索使用 SQL LIKE（模糊匹配），无语义理解能力。上下文窗口固定 20 轮，无智能裁剪。

#### 任务 4.1：全文搜索升级

- **目标**：利用 SQLite FTS5 实现高效全文搜索
- **工作内容**：
  - 创建 FTS5 虚拟表用于 memory 和 messages
  - 支持中文分词（使用 simple tokenizer 或 unicode61）
  - 搜索结果按相关性排序（BM25）
  - `/search` 命令输出高亮匹配关键词
- **验收标准**：
  - [ ] `/search` 返回结果按相关性排序
  - [ ] 中文搜索可用（分词正确）
  - [ ] 搜索延迟 < 50ms（1000 条记录以内）
  - [ ] 单元测试覆盖搜索排序和中文场景

#### 任务 4.2：上下文窗口优化

- **目标**：智能管理对话历史，提升长对话质量
- **工作内容**：
  - 可配置的 `maxTurns`（从配置读取）
  - 工具结果压缩：长输出（>2KB）自动摘要
  - System prompt 优化：动态注入相关 memory 条目
  - Token 计数估算（按字符数粗估，4 字符 ≈ 1 token）
- **验收标准**：
  - [ ] `maxTurns` 可通过配置调整
  - [ ] 长工具输出被压缩，不会撑爆上下文
  - [ ] `/tokens` 命令显示当前估算 Token 用量
  - [ ] 单元测试覆盖压缩和 Token 估算逻辑

#### 任务 4.3：会话持久化

- **目标**：退出后重新打开可恢复上次会话
- **工作内容**：
  - 退出时自动保存活跃会话到 `.kele/sessions/`
  - 启动时检查并提示恢复上次会话
  - `/sessions` 显示历史会话列表（含时间和摘要）
  - `/load <id>` 加载历史会话
- **验收标准**：
  - [ ] 正常退出后重启，提示恢复上次会话
  - [ ] 历史会话列表显示时间和首条消息摘要
  - [ ] 加载历史会话后可继续对话
  - [ ] 会话文件格式兼容（不丢失旧数据）

---

### Epic 5：稳定性与质量

**背景**：当前测试覆盖仅限 TUI 模块（4 个测试文件），其他核心模块无测试。安全检查基于简单黑名单。

#### 任务 5.1：核心模块测试补齐

- **目标**：关键模块测试覆盖率 > 60%
- **工作内容**：
  - `internal/llm/` — 请求构造、响应解析、流式处理（mock HTTP）
  - `internal/agent/` — 工具循环、历史管理、消息构造
  - `internal/memory/` — CRUD、搜索、文件同步
  - `internal/tools/` — 工具执行、安全检查、参数解析
- **验收标准**：
  - [ ] 每个 `internal/` 包至少有 1 个 `_test.go` 文件
  - [ ] `go test ./...` 全部通过
  - [ ] 核心路径（Chat、Execute、SaveMessage）有测试覆盖
  - [ ] Mock 接口用于隔离外部依赖（HTTP、文件系统）

#### 任务 5.2：安全加固

- **目标**：提升工具执行的安全性
- **工作内容**：
  - 危险命令列表统一管理（从配置加载，消除两处重复定义）
  - Bash 输出截断：默认上限 50KB
  - 添加命令执行超时（默认 60 秒，可配置）
  - 文件写入限制：大小上限 1MB
  - 日志记录：所有工具调用写入审计日志
- **验收标准**：
  - [ ] 危险命令列表在配置中统一定义
  - [ ] 超大输出被截断并附加提示
  - [ ] 超时命令被强制终止
  - [ ] 审计日志记录每次工具调用（时间、工具名、参数、结果摘要）

#### 任务 5.3：错误处理完善

- **目标**：用户遇到错误时能理解问题并采取行动
- **工作内容**：
  - LLM API 错误分类：网络错误、认证失败、限流、模型不存在
  - 自动重试：网络错误和限流自动重试（最多 3 次，指数退避）
  - 工具执行错误：清晰的错误消息（非 raw stack trace）
  - TUI 层错误提示：底部状态栏显示最近一条错误
- **验收标准**：
  - [ ] API Key 未设置时启动提示配置方法
  - [ ] 网络超时自动重试，TUI 显示重试状态
  - [ ] 限流时显示等待时间
  - [ ] 所有错误消息对用户友好（中文）

---

## 三、优先级排序与依赖关系

```
阶段 1（基础设施）    阶段 2（核心功能）       阶段 3（扩展与完善）
┌─────────────┐     ┌──────────────┐       ┌──────────────┐
│ 1.1 配置系统  │────→│ 2.1 Provider │──┬──→│ 2.2 Claude   │
│ 1.2 CLI参数   │     │     接口抽象  │  │   │ 2.3 Ollama   │
└─────────────┘     └──────────────┘  │   │ 2.4 模型管理  │
                                       │   └──────────────┘
┌─────────────┐     ┌──────────────┐  │   ┌──────────────┐
│ 3.1 工具注册  │────→│ 3.2 HTTP工具  │  │   │ 3.3 Git工具   │
│     机制重构  │     │ 3.4 Python   │  │   └──────────────┘
└─────────────┘     └──────────────┘  │
                                       │   ┌──────────────┐
┌─────────────┐                        └──→│ 4.2 上下文优化 │
│ 4.1 全文搜索  │                           │ 4.3 会话持久化 │
│ 5.1 测试补齐  │                           └──────────────┘
│ 5.2 安全加固  │
│ 5.3 错误处理  │                           ┌──────────────┐
└─────────────┘                            │   发布 v0.2.0  │
                                            └──────────────┘
```

**阶段 1 — 基础设施**（无外部依赖，可并行）
- 任务 1.1 + 1.2（配置系统）
- 任务 3.1（工具注册机制）
- 任务 4.1（全文搜索）
- 任务 5.1 + 5.2 + 5.3（质量保障）

**阶段 2 — 核心功能**（依赖阶段 1）
- 任务 2.1（Provider 接口）← 依赖 1.1
- 任务 3.2 + 3.4（HTTP + Python 工具）← 依赖 3.1

**阶段 3 — 扩展完善**（依赖阶段 2）
- 任务 2.2 + 2.3 + 2.4（Claude / Ollama / 管理UI）← 依赖 2.1
- 任务 3.3（Git 工具）← 依赖 3.1
- 任务 4.2 + 4.3（上下文优化 + 会话持久化）← 依赖 1.1

---

## 四、验收检查清单（Release Checklist）

### 功能验收

- [ ] `kele --version` 输出 `v0.2.0`
- [ ] `kele --config custom.yaml` 正常加载自定义配置
- [ ] 默认配置下行为与 v0.1.3 完全一致（向后兼容）
- [ ] OpenAI 模型正常对话 + 工具调用
- [ ] Claude 模型正常对话 + 工具调用（需 ANTHROPIC_API_KEY）
- [ ] Ollama 本地模型正常对话（需本地运行 Ollama）
- [ ] `/models` 按 Provider 分组显示
- [ ] `/model <name>` 模糊匹配切换模型
- [ ] AI 可调用 curl 工具获取网页/API 数据
- [ ] AI 可执行 git status / diff / log / add / commit
- [ ] AI 可执行 Python 代码片段
- [ ] `/search` 全文搜索结果按相关性排序
- [ ] `/tokens` 显示当前 Token 估算用量
- [ ] 退出后重启可恢复上次会话
- [ ] 危险命令被拦截（bash 和 cron 统一规则）

### 质量验收

- [ ] `go test ./...` 全部通过
- [ ] 每个 `internal/` 包至少 1 个测试文件
- [ ] `go vet ./...` 无警告
- [ ] `golangci-lint run` 无 error 级别问题
- [ ] 无 hardcoded API key、密码或敏感信息
- [ ] CHANGELOG.md 更新
- [ ] README.md 更新（新功能说明）

### 性能验收

- [ ] 启动时间 < 1 秒（含配置加载）
- [ ] 内存占用 < 30MB（空闲状态）
- [ ] 搜索延迟 < 50ms（1000 条记录）
- [ ] 流式响应首 token 延迟无显著退化

---

## 五、技术风险与缓解

| 风险 | 影响 | 缓解方案 |
|------|------|----------|
| Anthropic API 工具调用格式与 OpenAI 差异大 | 适配工作量大 | 先写完整的格式转换测试，再实现适配器 |
| Ollama 工具调用支持不稳定 | 部分功能退化 | 实现 graceful degradation，无工具时提示用户 |
| SQLite FTS5 中文分词效果差 | 搜索质量低 | 使用 unicode61 tokenizer + 空格分词预处理 |
| 配置系统重构影响面大 | 引入回归 Bug | 先写测试，再重构；保持接口兼容 |
| 多 Provider 共享数据库路径冲突 | 数据损坏 | 已知问题（scheduler/memory 共用 DB），v0.2.0 中分离 |

---

## 六、不包含在 v0.2.0 的功能（明确排除）

以下功能推迟到 v0.3.0+：

- ❌ Web UI 控制面板
- ❌ 插件系统 / 工具市场
- ❌ 向量嵌入 / 语义搜索（需要外部向量数据库，复杂度高）
- ❌ WhatsApp / Telegram / Discord 集成
- ❌ 多用户 / 团队协作
- ❌ Google Gemini 适配（API 格式差异极大，推迟到有需求时）
- ❌ Heartbeat 自主机制（需要更完善的安全模型支撑）
